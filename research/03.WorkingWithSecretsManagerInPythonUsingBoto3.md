# WORKING WITH SECRETS MANAGER IN PYTHON USING BOTO3

from: https://hands-on.cloud/working-with-secrets-manager-in-python-using-boto3/

- AWS Secrets Manager 는 어플리케이션, 서비스, IT리소스 등 보안 정보에 접근을 보호하는데 도움을 준다. 
- 이 서비스를 이용하면 쉽게 로테이트, 관리, 데이터베이스 크레덴셜을 순회할 수 있다.
- API 키, 패스워드 그리고 다른 시트릿을 이들의 라이프사이클을 통해 동작한다. 
- Boto3는 Python 소프트웨어 개발 킷이며, AWS 리소스와 파이썬 코드를 통합한다. 
- 이 아티클은 AWS SEcrets Manager에서 Boto3 라이브러리를 어떻게 사용할 수 있는지에 대한 글이다. 

## What is AWS Secrets Manager?

- credentials, tokens, API keys 등을 이용하여 특정 서비스에 접근하는 경우 다양한 시나리오가 있다. 
- 예를 들어 어플리케이션에서 DB 서버의 크레덴셜을 이용하고자 할경우가 해당된다. 
- 이러한 크레덴셜을 plain text 파일로 소스 코드에 저장하면, 보안 취약점이 생긴다. 
- 이런경우 시크릿을 인가되지 않은 접근이 되거나, 악의적인 활동에 노출된다. 
- AWS Secrets Manager는 민감한 정보를 저장하고, 안전하게 어플리케이션 설정 파일과 코드에서 이용할 수 있도록 키를 이용하여 접근하도록 한다. 

## AWS Parameter Store vs Secrets Manager

- AWS Secrets Manager는 크레덴셜 정보(데이터베이스 암호, API키등) 가 암호화 될 필요가 있는경우 사용되도록 설계 되었다. 
- 기본적으로 암호화 된 시크릭 엔터티를 생성함으로 이를 달성할 수 있다. 

- AWS Systems Manager Parameter Store는 다양한 유즈케이스에 이용하도록 디자인 되었다. 
- 이는 시크릿, 비밀번호 뿐만 아니라, 어플리케이션 설정도 이용이 가능하다. 

||Secrets Manager| Parameter Store Advanced| Parameter Store Standard|
|---|---|---|---|
|저장소크기 Size| 64KB| 8KB| 4KB|
|계정당 시크릿 개수| 40,000| 100,000| 10,000|
|최대 처리량| 5,000| 3,000| 3,000|
|시크릿 로테이션| YES| NO| NO|
|시크릿 생성| YES| NO| NO|
|KMS 암호화| YES| YES| YES|
|클라우드 포메이션 통합| YES| YES| YES|
|추가비용| 시크릿당 월비용| 파라미터당 월비용| 무료 |
|타계정접근| YES| NO| NO|

- Secrets Manager와 Parameter Store 둘다 AWS KMS를 이용하여 암호화 할 수 있다. 
- AWS Parameter Store 는 암호화 되지 않은 데이터도 저장할 수 있다. 
- 반면 Secrets Manager 는 암호화 되지 않은 데이터를 저장할지 않을 수 없다. 
- AWS KMS 는 높은 가용성의 키 저장소, 관리, 그리고 암호화된 데이터를 위한 감사 기능을 제공한다. 
- KMS 를 이용하여 IAM 사용자와 롤에 복호화를 허용하기 위한 권한 컨트롤을 할 수 있다. 

- 파라미터 스토어는 추가적인 비용이 없다. 그러나 현재 저장할 수 있는 파라미터의 수는 10,000 이다. 

- 파라미터 스토어는 각각의 값을 계층적 키를 이용한다. 
- /my-app/prod/db/password, /my-app/dev/db/password 와 같은 키를 생성할 수 있다. 
- 그리고 /my-app 키로 시작되는 모든 값을 조회할 수 있다. 

```py
aws ssm get-parameters-by-path /my-app/prod
```

- Parameter Store에서 관리하는 자격 증명을 업데이트 하고, Cloud Watch 예약 이벤트 또는 EventBridge 를 통해 이를 호출하는 고유한 함수를 작성할 수 있다. 
- AWS Secrets Manager 는 추가적인 비용이 든다. 

- AWS Secrets Manager는 내장된 통합툴을 가지고 있으며 MySQL, Postgres SQL, Amazon Aurora 그리고 RDS 데이터베이스 크레덴셜을 로테이션 할 수 있다. 
- 통합되지 않은 서비스의 경우 Lambda 함수가 이러한 다른 형태의 저장된 비밀을 교체할 수 있다. 
- 다른 AWS 서비스와 마찬가지로 기본 제공 통합은 앞으로 더 많은 AWS 서비스를 포함하도록 확장될 것이다. 
- 이는 결국 한 곳에서 전체 AWS 플랫폼의 모든 비밀을 관리할 수 있음을 의민한다. 

- AWS Secrets Manager는 또한 랜덤 시크릿을 생성할 수 있다. 
- 이를 통해 랜덤으로 CloudFormation 에서 비밀번호를 생성하고, Secrets Manager에 저장할 수 있다. 
- 또한 복수 계정에서 공유할 수 있다. 

## How do I access AWS Secrets Manager in Python?

- AWS Secrets Manager에 접속하기 위해서 Boto3를 설치할 필요가 있다. 
- AWS SDK를 파이썬에 이용할 수 있다. 
- 또한 AWS CLI 설정을 했다면 Boto3라이브러리를 사용할 수 있다. 
- Boto3 는 Access Key Id 와 Secret Access Key 를 이용하여 프로그램으로 AWS 리소스를 관리할 수 있다. 

- 첫번째로 AWS CLI 를 설치해야한다. 이는 운영체제에 의존한다. 
- AWS CLI 설치 이후에 aws configure를 실행하여 AWS CLI를 이용하여 게정을 설정하자. 
- Access Key Id 그리고 Secret Access Key 를 IAM에서 받은 내용을 입력한다. 

- 두번째로 boto3 라이브러리를 설치하고 pip install boto3 로 설치하자. 
- 더 많은 정보를 위해서는 https://hands-on.cloud/introduction-to-boto3-library/ 에서 참조하자. 

## How do I get my secret from AWS Secrets Manager?

- AWS Console에서 Secrets Manager를 찾는다. 그리고 다음과 같이 지정하자. 

![secrets](https://hands-on.cloud/wp-content/uploads/2021/08/aws_secrets_manager.jpg?ezimgfmt=ng:webp/ngcb1)

- secrets의 하나를 클릭하고, Retrieve secret value 버튼을 클릭하여 시크릿 값을 확인할 수 있다. 

![secrets02](https://hands-on.cloud/wp-content/uploads/2021/08/aws_retrieve_secret_value.png?ezimgfmt=ng:webp/ngcb1)

- 여기에서 다음을 확인할 수 있다. 

![secrets03](https://hands-on.cloud/wp-content/uploads/2021/08/aws_secret_value.png?ezimgfmt=ng:webp/ngcb1)

## How to create a secret in AWS Secrets Manager using Boto3?

- Secrets Manager 는 암호화되 시크릿을 버젼 모음에 저장한다. 
- 각 버젼은 암호화된 시크릿 데이터의 복제본을 포함한다. 
- 각 버젼은 하나 혹은 여러개의 스테이징 레벨과 연관되며, 로테이션 사이클에 버젼으로 저장된다. 

- Boto3 Secrets Manager 'client' 는 저수준의 클래스로, AWS Secrets Manager에 접근하는 방법을 제공한다. 
- 모든 서비스 API들은 Boto3 클라이언트 맵에서 AWS service API와 1:1 로 매핑된다. 

- 시크릿 스트링 매개 변수에 텍스트를 입력하거나 SecretBinary 매개변수에 바이너리 데이터를 입력하여 암호화할 비밀 데이터를 제공할 수 있지만 둘 다 제공할수는 없다. 
- 만약 SecretString 혹은 SecretBinary 를 포함하면 Secrets Manager는 초기 암호 버젼도 생성하고, 스테이징 레이블 AWSCURRENT 를 새 버젼으로 자동으로 연결할 수 있다. 

```py
#!/usr/bin/env python3

import boto3

client = boto3.client('secretsmanager')

response = client.create_secret(
    Name='DatabaseProdSecrets',
    SecretString='{"username": "prod", "password": "hello-world-prod"}'
)
```

- 만약 custom KMS 키를 제공이 필요하다. 이때 KmsKeyId 파라미터를 create_secret() 메소드에 이용할 수 있다. 
- 이는 ARN, Key ID 혹은 Amazon Web Service KMS 커스터머 마스터 키 (CMK) 의 ARN 파라미터를 사용할 수 있다. 
- KmsKeyId를 제공하지 않으면 Secrets Manager는 계정의 기본 CMK(aws/secrets manager 이라는 이름의 CMK)를 사용한다. 
- 해당 이름의 경우 Amazon Web Services KMS CMK가 존재하지 않는 경우 Secrets Manager는 버젼의 SecretString또는 SecretBinary필드를 처음 암호화해야 할 때 자동으로 생성한다. 

## How to list secrets in AWS Secrets Manager using Boto3?

- list_secrets() 메서드를 사용하여 AWS Secrets Manager에 저장된 모든 암호를 나열할 수 있다. 
- 시크릿을 리스팅 할때 당신은 특정 개수의 결과를 제한하고 필터할 수 있다. 

- 노트: 
  - 암호화된 필드 SecretString과 SecretBinary 들은 출력에 포함되지 않는다. 
  - 정보를 얻기 위해서 당신은 GetSecretValue 오퍼레이션을 부를 필요가 있다. 

```py
#!/usr/bin/env python3

import boto3

client = boto3.client('secretsmanager')

response = client.list_secrets()

print(response['SecretList'])
```

## How to retrieve a secret value from AWS Secrets Manager using Boto3?

- AWS Secrets Manager 로 부터 시크릿을 Boto3를 이용하여 조회할때, get_secret_value() 메소드를 이용할 필요가 있다. 
- 다음 코드 예제들은 DatabaseProdSecrets 의 SecretId(또는 생성 시 Name)를 사용하여 비밀을 가져온다. 
- Boto3를 이용한 [Secrets Manager document](https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/secretsmanager.html)를 참조하자. 

- 당신은 또한 SecretString 값을 파싱할 필요가 있고, 이는 json.loads 를 이용하여 JSON 문자를 Python 딕셔너리로 변환하는 값을 구문 분석해야한다. 

```py
#!/usr/bin/env python3

import boto3 
import json 

client = boto3.client('secretsmanager')

response = client.get_secret_value(
    SecretId='DatabaseProdSecrets'
)

database_secrets = json.loads(response['SecretString'])

print(database_secrets['password'])
```

## Permissions required to retrieve a secret

- 시크릿을 조회하기 위해서 secretsmanager:GetSecretValue API 를 허용할 필요가 있다. 이는 IAM에서 설정한다. 
- 만약 customer-managed Amazon Web Services KMS 키를 이용하여 암호화 한다면 kms:Decrypt 퍼미션을 주어야한다. 
- 반대로 SecretsManagerReadWrite 정책을 사용자에게 부여할 수 있다. 이는 AWS Secrets Manager를 관리할 수 있도록 허용한다. 

![secrets04](https://hands-on.cloud/wp-content/uploads/2021/08/iam_secrets_manager_policy.jpg?ezimgfmt=ng:webp/ngcb1)

## Retrieve a secret values from the Python code 

- AWS Secrets Manager 로 시크릿 값을 Boto3를 이용하여 접근하다면, get_secret_value() 메소드를 이용하면 된다. 

```py
#!/usr/bin/env python3

import boto3
import json 

client = boto3.client('secretsmanager')

response = client.get_secret_value(
    SecretId='DatabaseProdSecrets'
)

database_secrets = json.loads(response['SecretString'])

print(database_secrets['password'])
```

## Retrieve a secret values in Bash 

- AWS CLI 를 이용하여 secret value를 이용할때 다음과 같이 수행할 수 있다. 

```py
aws secretsmanager get-secret-value --secret-id <SecretId>

```

## Retrieve a secret values in Powershell

- 각 서비스에 대한 PowerShell용 AWS 도구의 cmdlet은 서비스에 대해 AWS SDK에서 제공하는 방법을 기반으로 한다. 
- Get-SECSecretValue cmdlet을 이용하여 시크릿을 조회할 수 있다. 
- 더 많은 내용은 https://docs.aws.amazon.com/powershell/latest/reference/items/Get-SECSecretValue.html 을 참조하자. 

```py
Get-SECSecretValue -SecretId <SecretId>

```

## How to update an existing secret in AWS Secrets Manager using Boto3?

- 업데이트 에는 2가지 메소드가 있다. 
- 첫번째는 put_secret_value() 를 이용하는 것으로, 새로운 버젼을 생성하고, 시크릿에 첨부한다. 

```py
#!/usr/bin/env python3

import boto3 
import json 

client = boto3.client('secretsmanager')

response = client.put_secret_value(
    SecretId='DatabaseProdSecrets',
    SecretString='{"username": "prod", "password": "hello-world-updated2"}'
)

print(response)
```

- 다음은 update_secret() 메소드이다. 
- 이 메소드는 지정된 시크릿의 상세부분을 변경한다. 
- 만약 ClientRequestToken 을 포함한다면 그리고 SecretString 혹은 SecretBinary 둘다 새로운 버젼을 생성하고, secret을 첨부한다. 

```py
#!/usr/bin/env python3

import boto3 
import json

client = boto3.client('secretsmanager')

response = client.update_secret(
    SecretId='DatabaseProdSecrets',
    Description='Description updated'
)

print(response)
```

## How to create a new version of the secret in AWS Secrets Manager using Boto3?

- 당신은 put_secret_value 혹은 update_secret 을 이용하여 새로운 버젼을 생성할 수 있다. 
- put_secret_value 는 새로운 버젼을 생성하고 시크릿을 첨부할 수 있다. 
- update_secret 메소드는 새로운 버젼을 생성하고, 시크릿에 첨부한다. ClientRequestToken 과 SecretString 또는 SecretBinary 매배변수가 사용될 때 비밀에 첨부된 새 버젼을 생성한다. 

## How to delete a secret in AWS Secrets Manager using Boto3?

- delete_secret() 함수를 이용할 수 있다. 이는 시크릿을 삭제하고, 모든 버젼을 제거한다. 
- 비밀을 복원할 수 있는 복구 기간을 선택적으로 포함 할 수 있다. 
- 만약 복구 기간 값을 지정하지 않으면 30일 이내에 비밀이 삭제된다. 

- 복구 윈도우가 끝나기 전에 언제든지 RestoreSecret을 이용하여 DeletionDate 를 제거할 수 있다. 그리고 시크릿의 삭제를 제거할 수 있다. 

```py
#!/usr/bin/env python3

import boto3

client = boto3.client('secretsmanager')

response = client.delete_secret(
    SecretId='DatabaseProdSecrets',
    RecoveryWindowInDays=10,
    ForceDeleteWithoutRecovery=False
)

print(response)
```

- recovery window 가 끝나기 전에 삭제된 시크릿을 복구하면 당신은 restore_secret() 메소드를 이요할 수 있다. 

```py
#!/usr/bin/env python3

import boto3

client = boto3.client('secretsmanager')

response = client.restore_secret(
    SecretId='DatabaseProdSecrets'
)

print(response)
```

## Summary

- 이 아티클은 파이썬을 어떻게 이용할지를 보여준다. 
- 시크릿 생성, 수정, 삭제를 Boto3를 이용하여 사용해 보았다. 